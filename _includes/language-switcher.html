<!-- Language Switcher and Theme Toggle Component -->
<div class="controls-wrapper">
  <div class="language-switcher">
    <div class="language-toggle">
      <button id="lang-btn" class="lang-button" onclick="toggleLanguage()">
        <span id="current-lang">üåê EN</span>
        <span class="lang-arrow">‚ñº</span>
      </button>
      <div id="lang-dropdown" class="lang-dropdown">
        <a href="#" onclick="setLanguage('en')" class="lang-option" data-lang="en">
          üá∫üá∏ English
        </a>
        <a href="#" onclick="setLanguage('zh')" class="lang-option" data-lang="zh">
          üá®üá≥ ‰∏≠Êñá
        </a>
      </div>
    </div>
  </div>
  
  <!-- Dark Mode Toggle -->
  <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode">
    <span id="theme-icon">üåô</span>
  </button>
</div>

<script>
// Language switching functionality
let currentLang = localStorage.getItem('blog-language') || '{{ site.default_lang }}';

// Theme management with system preference detection
let currentTheme = localStorage.getItem('blog-theme') || 'auto';

// Initialize language and theme on page load
document.addEventListener('DOMContentLoaded', function() {
  setLanguage(currentLang, false);
  initializeTheme();
});

// Theme initialization
function initializeTheme() {
  if (currentTheme === 'auto') {
    // Use system preference
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    applyTheme(prefersDark ? 'dark' : 'light', false);
    updateThemeIcon('auto');
  } else {
    applyTheme(currentTheme, false);
    updateThemeIcon(currentTheme);
  }
  
  // Listen for system theme changes
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
    if (currentTheme === 'auto') {
      applyTheme(e.matches ? 'dark' : 'light', false);
    }
  });
}

// Theme toggle functionality
function toggleTheme() {
  const themes = ['auto', 'light', 'dark'];
  const currentIndex = themes.indexOf(currentTheme);
  const nextIndex = (currentIndex + 1) % themes.length;
  currentTheme = themes[nextIndex];
  
  localStorage.setItem('blog-theme', currentTheme);
  
  if (currentTheme === 'auto') {
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    applyTheme(prefersDark ? 'dark' : 'light', true);
  } else {
    applyTheme(currentTheme, true);
  }
  
  updateThemeIcon(currentTheme);
}

// Apply theme to document
function applyTheme(theme, animate = true) {
  if (animate) {
    document.documentElement.style.transition = 'background-color 0.3s ease, color 0.3s ease';
  }
  
  if (theme === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
  } else {
    document.documentElement.setAttribute('data-theme', 'light');
  }
  
  if (animate) {
    setTimeout(() => {
      document.documentElement.style.transition = '';
    }, 300);
  }
}

// Update theme icon
function updateThemeIcon(theme) {
  const themeIcon = document.getElementById('theme-icon');
  const themeButton = document.getElementById('theme-toggle');
  
  switch (theme) {
    case 'auto':
      themeIcon.textContent = 'üåì';
      themeButton.title = 'Theme: Auto (follows system)';
      break;
    case 'light':
      themeIcon.textContent = '‚òÄÔ∏è';
      themeButton.title = 'Theme: Light';
      break;
    case 'dark':
      themeIcon.textContent = 'üåô';
      themeButton.title = 'Theme: Dark';
      break;
  }
}

function toggleLanguage() {
  const dropdown = document.getElementById('lang-dropdown');
  dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
}

function setLanguage(lang, reload = true) {
  currentLang = lang;
  localStorage.setItem('blog-language', lang);
  
  // Update button display
  const currentLangSpan = document.getElementById('current-lang');
  if (lang === 'en') {
    currentLangSpan.textContent = 'üåê EN';
    document.documentElement.lang = 'en';
  } else {
    currentLangSpan.textContent = 'üåê ‰∏≠Êñá';
    document.documentElement.lang = 'zh';
  }
  
  // Hide dropdown
  document.getElementById('lang-dropdown').style.display = 'none';
  
  // Filter content based on language
  filterContentByLanguage(lang);
  
  // Update page title and description
  updatePageContent(lang);
}

function filterContentByLanguage(lang) {
  // Filter posts on homepage - only show posts in selected language
  const posts = document.querySelectorAll('.post-list li');
  let visibleCount = 0;
  
  posts.forEach(post => {
    const postLang = post.getAttribute('data-lang') || 'zh'; // Default to Chinese for existing posts
    if (postLang === lang) {
      post.style.display = 'block';
      visibleCount++;
    } else {
      post.style.display = 'none';
    }
  });
  
  // Show message if no posts in selected language
  const existingMsg = document.getElementById('no-posts-message');
  if (existingMsg) {
    existingMsg.remove();
  }
  
  if (visibleCount === 0) {
    const msg = document.createElement('div');
    msg.id = 'no-posts-message';
    msg.className = 'no-posts-message';
    msg.innerHTML = lang === 'en' ? 
      'No posts available in English yet. <a href="#" onclick="setLanguage(\'zh\')">Switch to Chinese</a>' :
      'ÊöÇÊó†‰∏≠ÊñáÊñáÁ´†„ÄÇ<a href="#" onclick="setLanguage(\'en\')">ÂàáÊç¢Âà∞Ëã±Êñá</a>';
    
    const postList = document.querySelector('.post-list');
    if (postList) {
      postList.after(msg);
    }
  }
}

function updatePageContent(lang) {
  // Update site title
  const siteTitle = document.querySelector('.site-title');
  if (siteTitle) {
    if (lang === 'zh') {
      siteTitle.textContent = 'Â≠êÊòìËµõÂçö„ÅÆÁ©∫Èó¥';
    } else {
      siteTitle.textContent = "Zee's Cyber Space";
    }
  }
  
  // Update navigation links
  const navLinks = document.querySelectorAll('.page-link');
  navLinks.forEach(link => {
    const href = link.getAttribute('href');
    if (href === '/about/' || href === '/about') {
      link.textContent = lang === 'zh' ? 'ÂÖ≥‰∫é' : 'About';
    }
  });
  
  // Update page heading if exists
  const pageHeading = document.querySelector('.page-heading');
  if (pageHeading && window.location.pathname === '/') {
    // Don't show any page heading on homepage
    pageHeading.style.display = 'none';
  }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
  const switcher = document.querySelector('.language-switcher');
  if (!switcher.contains(event.target)) {
    document.getElementById('lang-dropdown').style.display = 'none';
  }
});
</script>

<style>
.controls-wrapper {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-left: auto;
}

.language-switcher {
  position: relative;
  display: inline-block;
}

.lang-button {
  background: none;
  border: 1px solid #ddd;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 5px;
  transition: all 0.2s ease;
}

.lang-button:hover {
  border-color: #999;
  background-color: #f5f5f5;
}

.lang-arrow {
  font-size: 10px;
  transition: transform 0.2s ease;
}

.lang-dropdown {
  display: none;
  position: absolute;
  top: 100%;
  right: 0;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  z-index: 1000;
  min-width: 120px;
}

.lang-option {
  display: block;
  padding: 8px 12px;
  text-decoration: none;
  color: #333;
  font-size: 14px;
  transition: background-color 0.2s ease;
}

.lang-option:hover {
  background-color: #f5f5f5;
  text-decoration: none;
}

.no-posts-message {
  text-align: center;
  padding: 20px;
  color: #666;
  font-style: italic;
}

.no-posts-message a {
  color: #0066cc;
  text-decoration: underline;
}

/* Responsive design */
@media (max-width: 600px) {
  .controls-wrapper {
    margin: 10px 0;
    justify-content: flex-end;
    flex-wrap: wrap;
  }
  
  .lang-dropdown {
    right: auto;
    left: 0;
  }
  
  .theme-toggle {
    order: -1; /* Put theme toggle first on mobile */
  }
}
</style>